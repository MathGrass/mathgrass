<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Task Management - MathGrass</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Task Management";
        var mkdocs_page_input_path = "developer_guide/backend/taskmanagement.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> MathGrass
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">General</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../..">About this Project</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../features/">Teaching and Learning with MathGrass</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Deployment</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../deployment/">Deployment</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Developer Guide (general)</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../quickstart/">Quickstart</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../openapi/">OpenAPI Specification for MathGrass</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Developer Guide (Backend)</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../concepts/">Concepts & Domain</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../API_Implementation/">API Implementation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../evaluator/">Evaluator (Python)</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Task Management</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#task-execution">Task Execution</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#delayed-task-execution">Delayed Task Execution</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#task-queue">Task Queue</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#configuration">Configuration</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#implementation-details">Implementation Details</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#task-manager">Task Manager</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#event-bus">Event Bus</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Developer Guide (Frontend)</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../frontend/">General</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../frontend/testing/">Testing</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">MathGrass</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
          <li>Developer Guide (Backend) &raquo;</li>
      <li>Task Management</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="task-management">Task Management</h1>
<h2 id="overview">Overview</h2>
<p>The task management is a core component of the backend. It is responsible for the management and execution of tasks.
This page gives an overview over the functionality of the task management as well as some implementation details.</p>
<blockquote>
<p>Attention: This page refers to a client as the requester of a task evaluation. The client is in fact still part of the
backend. It is basically an endpoint, which triggers the task execution and
can be called by actual clients.</p>
</blockquote>
<p><img alt="Task evaluation process" src="../../images/task_evaluation_process.png" />
<em>General task execution process. The client sends a request to the task execution manager, which then evaluates 
submitted task, stores the result in the database and notifies the client. The client can then fetch the result from 
the database.</em></p>
<h2 id="task-execution">Task Execution</h2>
<p>Since (especially dynamic) tasks may take a longer time to be processed, the task management was designed
to be asynchronous. This means that the client does not need to wait for the task to be finished, but 
gets a task result id instead. The client can then use this id to check the status of the task.
Once the task has been processed an event is emitted over an event bus to notify the client about the completion
of the task, upon which the client can retrieve the result of the task. The task executor is able to process multiple
tasks at the same time using multiple threads.</p>
<h2 id="delayed-task-execution">Delayed Task Execution</h2>
<p>The process of requesting a task evaluation is asynchronous. First a task result is created, then a task is scheduled
for execution and finally the task result ID is returned, which can then be used to register a listener for task 
completion. However, especially when requesting the evaluation of static tasks, the execution of the task evaluation
might be called directly and post the task evaluation completion event before the listener could be registered.
To solve this issue a custom DelayedTaskExecutor was implemented, which is able to delay the execution of the task 
evaluation. By adding a minimal delay of e.g. 50 ms the listener can be created before the task evaluation is finished
in any circumstances.</p>
<h2 id="task-queue">Task Queue</h2>
<p>The task management uses a task queue to limit and manage the number of tasks that are executed at the same time.
This is necessary, since the evaluation of dynamic tasks requires the instantiation of Docker containers, which can be
quite expensive. If the task executor has reached its maximum number of tasks, a new task request will be placed in the
queue and will be executed as soon as a slot is available.</p>
<h2 id="configuration">Configuration</h2>
<p>The task manager can be configured with three parameters:
 - <code>corePoolSize</code>: Minimal number of threads kept alive in the thread pool. (Default: 1)
 - <code>maxPoolSize</code>: Maximum number of threads in the thread pool. (Default: 5)
 - <code>queueCapacity</code>: Maximum number of tasks that can be stored in the queue. (Default: Integer.MAX_VALUE)</p>
<blockquote>
<p>Note: The core pool size typically determines the number of tasks that can be executed in parallel. There are only new
threads spawned if the number of tasks exceeds the core pool size. The maximum pool size determines the maximum number
of threads that can be spawned in total. By default, the queueCapacity is set to a high number, so it is unlikely that
threads are spawned than the core pool size.</p>
</blockquote>
<p>All parameters can be set in the <code>application.properties</code> file.</p>
<h2 id="implementation-details">Implementation Details</h2>
<h3 id="task-manager">Task Manager</h3>
<p>The task manager is implemented using Springs <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/scheduling/concurrent/ThreadPoolTaskExecutor.html">ThreadPoolTaskExecutor</a>.
It offers all necessary functionality to fit the requirements of the task management: 
 - limit number of tasks executed at the same time -&gt; limit number of spawned Docker containers
 - task queue to store tasks that cannot be executed at the moment
 - asynchronous task execution
 - easy to use in Spring applications</p>
<h3 id="event-bus">Event Bus</h3>
<p>The event bus is implemented using Googles <a href="https://guava.dev/releases/19.0/api/docs/com/google/common/eventbus/EventBus.html">Guava EventBus</a>.
An alternative was using Springs integrated ApplicationEvents, which had the major problems of events shared between different threads.
The advantage of the EventBus is that it is thread safe, allows to register multiple listeners for the same event and it is easier to use.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../evaluator/" class="btn btn-neutral float-left" title="Evaluator (Python)"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../frontend/" class="btn btn-neutral float-right" title="General">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../evaluator/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../frontend/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme_extra.js" defer></script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
